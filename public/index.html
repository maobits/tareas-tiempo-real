<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tareas en Tiempo Real</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestor de Tareas</h1>
    </header>

    <div class="form-container">
      <form id="nuevaTarea">
        <input type="text" id="titulo" placeholder="Nueva Tarea" required />
        <button type="submit">Agregar</button>
      </form>
    </div>

    <section id="tareas-container">
      <h2>Lista de Tareas</h2>
      <ul id="tareas"></ul>
    </section>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const tareasElement = document.getElementById('tareas');
    const nuevaTareaForm = document.getElementById('nuevaTarea');

    socket.on('nuevaTarea', (tarea) => {
      agregarTarea(tarea);
    });

    socket.on('actualizarTarea', (tarea) => {
      actualizarTareaEnUI(tarea);
    });

    socket.on('eliminarTarea', (id) => {
      eliminarTareaDeUI(id);
    });

    nuevaTareaForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value;
      fetch('/tareas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ titulo, completado: false }),
      }).then(() => {
        document.getElementById('titulo').value = '';
      });
    });

    // Cargar las tareas actuales
    fetch('/tareas')
      .then((res) => res.json())
      .then((tareas) => {
        tareas.forEach(agregarTarea);
      });

    function agregarTarea(tarea) {
      const li = document.createElement('li');
      li.textContent = tarea.titulo;
      li.dataset.id = tarea._id;

      const container = document.createElement('div');
      container.classList.add('tarea-container');

      const botonCompletado = document.createElement('button');
      botonCompletado.textContent = tarea.completado ? 'Completada' : 'Marcar como completada';
      botonCompletado.classList.add('btn', 'btn-completado');
      botonCompletado.addEventListener('click', () => {
        fetch(`/tareas/${tarea._id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ completado: !tarea.completado }),
        })
        .then(response => response.json())  // Asegúrate de obtener la respuesta JSON
        .then(updatedTarea => {
          // Cambiar el texto del botón según el nuevo estado
          botonCompletado.textContent = updatedTarea.completado ? 'Completada' : 'Marcar como completada';
        })
        .catch(error => console.error('Error al actualizar la tarea:', error));
      });

      const botonEliminar = document.createElement('button');
      botonEliminar.textContent = 'Eliminar';
      botonEliminar.classList.add('btn', 'btn-eliminar');
      botonEliminar.addEventListener('click', () => {
        fetch(`/tareas/${tarea._id}`, {
          method: 'DELETE',
        }).then(() => {
          eliminarTareaDeUI(tarea._id);
        });
      });

      container.appendChild(li);
      container.appendChild(botonCompletado);
      container.appendChild(botonEliminar);
      tareasElement.appendChild(container);
    }

    function actualizarTareaEnUI(tarea) {
      const li = document.querySelector(`li[data-id="${tarea._id}"]`);
      if (li) {
        li.textContent = tarea.titulo;
      }
    }

    function eliminarTareaDeUI(id) {
      const li = document.querySelector(`li[data-id="${id}"]`);
      if (li) {
        li.parentElement.remove();
      }
    }
  </script>
</body>
</html>
